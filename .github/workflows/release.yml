name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build:
    name: Build ${{ matrix.target }}
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend
        run: |
          cd frontend && npm ci && npm run build
          cp -r dist ../src/exporter/static/

      - name: Build binary
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Package binary
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${TAG#c4-v}"
          ARCHIVE_NAME="c4_${VERSION}_${{ matrix.target }}"

          mkdir -p dist
          cp target/${{ matrix.target }}/release/c4 dist/
          cd dist
          tar -czvf "${ARCHIVE_NAME}.tar.gz" c4
          shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          gh release upload "$TAG" dist/*.tar.gz dist/*.sha256 --clobber

  homebrew:
    name: Update Homebrew Formula
    needs: [release-please, build]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Download release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          TAG="${{ needs.release-please.outputs.tag_name }}"
          gh release download "$TAG" --pattern "*.tar.gz" --dir dist
          gh release download "$TAG" --pattern "*.sha256" --dir dist

      - name: Create consolidated checksums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          cat dist/*.sha256 | sort > dist/checksums.txt
          gh release upload "$TAG" dist/checksums.txt --clobber

      - name: Generate Homebrew formula
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${TAG#c4-v}"

          DARWIN_AMD64_SHA=$(cat dist/c4_${VERSION}_x86_64-apple-darwin.tar.gz.sha256 | cut -d' ' -f1)
          DARWIN_ARM64_SHA=$(cat dist/c4_${VERSION}_aarch64-apple-darwin.tar.gz.sha256 | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(cat dist/c4_${VERSION}_x86_64-unknown-linux-gnu.tar.gz.sha256 | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(cat dist/c4_${VERSION}_aarch64-unknown-linux-gnu.tar.gz.sha256 | cut -d' ' -f1)

          cat > c4.rb << EOF
          class C4 < Formula
            desc "C4 architecture visualization tool"
            homepage "https://github.com/panbanda/c4"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/panbanda/c4/releases/download/${TAG}/c4_${VERSION}_aarch64-apple-darwin.tar.gz"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/panbanda/c4/releases/download/${TAG}/c4_${VERSION}_x86_64-apple-darwin.tar.gz"
                sha256 "${DARWIN_AMD64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/panbanda/c4/releases/download/${TAG}/c4_${VERSION}_aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/panbanda/c4/releases/download/${TAG}/c4_${VERSION}_x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${LINUX_AMD64_SHA}"
              end
            end

            def install
              bin.install "c4"
            end

            test do
              system "#{bin}/c4", "--version"
            end
          end
          EOF

          if [ -n "$HOMEBREW_TAP_GITHUB_TOKEN" ]; then
            git clone "https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/panbanda/homebrew-c4.git" tap
            mkdir -p tap/Formula
            cp c4.rb tap/Formula/c4.rb

            cd tap
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add Formula/c4.rb
            git commit -m "Update c4 to ${VERSION}"
            git push
          fi
